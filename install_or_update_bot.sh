#!/bin/bash

set -e  # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ ÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
DOCKER_UID=$(id -u)
DOCKER_GID=$(id -g)

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ
function check_command() {
    command -v "$1" >/dev/null 2>&1 || { echo >&2 "$1 Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ..."; install_command "$1"; }
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ
function install_command() {
    case "$1" in
        docker)
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            rm get-docker.sh
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ docker
            usermod -aG docker "${SUDO_USER:-$USER}"
            ;;
        docker-compose)
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            ;;
        git)
            apt-get update
            apt-get install -y git
            ;;
        *)
            echo "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸: $1"
            exit 1
            ;;
    esac
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
function setup_permissions() {
    local target_dir="$1"
    echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð², ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
    mkdir -p "$target_dir/logs"
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸ Ñ„Ð°Ð¹Ð»Ñ‹
    chmod -R 755 "$target_dir"
    chmod -R 777 "$target_dir/logs"
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð°
    chown -R "${SUDO_USER:-$USER}:${SUDO_USER:-$USER}" "$target_dir"
    
    echo "âœ… ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° root Ð¿Ñ€Ð°Ð²
if [ "$EUID" -ne 0 ]; then 
    echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root (sudo)"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
check_command "docker"
check_command "docker-compose"
check_command "git"

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð´Ð¾Ð¼Ð°ÑˆÐ½ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
HOME_DIR=$(eval echo ~${SUDO_USER})
TARGET_DIR="$HOME_DIR/telegram-publisher-bot"

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ -f "$TARGET_DIR/.env" ]; then
    echo "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
    cp "$TARGET_DIR/.env" /tmp/.env.backup
    chown "${SUDO_USER:-$USER}:${SUDO_USER:-$USER}" /tmp/.env.backup
fi

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
REPO_URL="https://github.com/gopnikgame/telegram-publisher-bot"

if [ -d "$TARGET_DIR" ]; then
    echo "ðŸ“‚ ÐŸÐ°Ð¿ÐºÐ° ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚. Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð¿Ð°Ð¿ÐºÐ¸ Ð¸ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð½Ð¾Ð²Ð¾..."
    rm -rf "$TARGET_DIR"
fi

echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
git clone "$REPO_URL" "$TARGET_DIR"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð´Ð»Ñ Ð²ÑÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
setup_permissions "$TARGET_DIR"

# Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°, ÐµÑÐ»Ð¸ Ð¾Ð½ Ð±Ñ‹Ð» ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½
if [ -f "/tmp/.env.backup" ]; then
    echo "ðŸ’¾ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
    mv /tmp/.env.backup "$TARGET_DIR/.env"
fi

cd "$TARGET_DIR" || exit

# Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ docker-compose Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¸Ð¼ÐµÐ½Ð°Ð¼Ð¸
export DOCKER_UID
export DOCKER_GID

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¸Ð»Ð¸ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ .env Ñ„Ð°Ð¹Ð»Ð°
function manage_env_file() {
    if [ ! -f .env ]; then
        echo ".env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾..."
        cat > .env << EOF
# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°
BOT_TOKEN=
ADMIN_IDS=
CHANNEL_ID=

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
DEFAULT_FORMAT=markdown
MAX_FILE_SIZE=20971520

# Ð¡ÑÑ‹Ð»ÐºÐ¸ (Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ [Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ](ÑÑÑ‹Ð»ÐºÐ°))
MAIN_BOT_LINK=
SUPPORT_BOT_LINK=
CHANNEL_LINK=

# Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
TEST_MODE=false
TEST_CHAT_ID=

# ÐŸÑ€Ð¾ÐºÑÐ¸ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½)
HTTPS_PROXY=
EOF
        chown "${SUDO_USER:-$USER}:${SUDO_USER:-$USER}" .env
    fi

    echo "ðŸ“ Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
    sudo -u "${SUDO_USER:-$USER}" nano .env
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
function check_config() {
    if [ ! -f .env ]; then
        echo "âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
        return 1
    fi

    local required_vars=("BOT_TOKEN" "ADMIN_IDS" "CHANNEL_ID")
    local missing_vars=()

    for var in "${required_vars[@]}"; do
        if ! grep -q "^${var}=." .env; then
            missing_vars+=("$var")
        fi
    done

    if [ ${#missing_vars[@]} -ne 0 ]; then
        echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð² .env:"
        printf '%s\n' "${missing_vars[@]}"
        return 1
    fi

    return 0
}

# ÐœÐµÐ½ÑŽ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
while true; do
    echo -e "\nðŸ“± Telegram Publisher Bot - ÐœÐµÐ½ÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸\n"
    echo "1. ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¸Ð»Ð¸ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ .env Ñ„Ð°Ð¹Ð»"
    echo "2. ðŸš€ Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
    echo "3. ðŸ“Š ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸"
    echo "4. ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
    echo "5. â­• ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
    echo "6. âŒ Ð’Ñ‹Ð¹Ñ‚Ð¸"
    read -r -p "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ (1-6): " choice

    case $choice in
        1)
            manage_env_file
            ;;
        2)
            if ! check_config; then
                echo -e "\nâš ï¸ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» (Ð¾Ð¿Ñ†Ð¸Ñ 1)"
                continue
            fi

            echo "ðŸ”„ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
            docker-compose down --remove-orphans

            # ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
            setup_permissions "$TARGET_DIR"

            echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¾Ð±Ñ€Ð°Ð·Ð°..."
            docker-compose build --no-cache

            echo "â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
            docker-compose up -d

            echo -e "\nâœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
            ;;
        3)
            docker-compose logs -f
            ;;
        4)
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
            docker-compose restart
            echo "âœ… Ð‘Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
            ;;
        5)
            echo "â¹ï¸ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±Ð¾Ñ‚Ð°..."
            docker-compose down
            echo "âœ… Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!"
            ;;
        6)
            echo "ðŸ‘‹ Ð”Ð¾ ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ñ!"
            exit 0
            ;;
        *)
            echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
            ;;
    esac
done